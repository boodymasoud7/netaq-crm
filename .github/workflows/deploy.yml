name: ğŸš€ Deploy CRM to AWS EC2 - DISABLED

on:
  # Disabled to prevent breaking production
  workflow_dispatch: # Manual trigger only

jobs:
  deploy:
    name: ğŸŒ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout code
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    # 2. Setup Node.js
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # 3. Install Backend Dependencies
    - name: ğŸ“¦ Install Backend Dependencies
      run: |
        cd crm-backend
        npm install --omit=dev

    # 4. Install Frontend Dependencies & Build
    - name: ğŸ“¦ Install Frontend Dependencies
      run: |
        cd crm-frontend-only
        # Fix npm optional dependencies bug
        rm -rf package-lock.json node_modules
        npm install

    - name: ğŸ—ï¸ Build Frontend
      run: |
        cd crm-frontend-only
        npm run build
      env:
        NODE_ENV: production
        VITE_API_URL: http://54.221.136.112/api
        VITE_ENVIRONMENT: production

    # 5. Deploy to AWS EC2
    - name: ğŸš€ Deploy to AWS EC2
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # Navigate to app directory
          cd /var/www/netaq-crm || { echo "âŒ App directory not found"; exit 1; }
          
          # Stop services gracefully
          echo "â¹ï¸ Stopping services..."
          pm2 stop netaq-backend || true
          pm2 stop netaq-frontend || true
          
          # Create backup
          echo "ğŸ’¾ Creating backup..."
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mkdir -p ~/backups
          tar -czf ~/backups/backup_$TIMESTAMP.tar.gz /var/www/netaq-crm/ || true
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin main
          git reset --hard origin/main
          
          # Install backend dependencies
          echo "ğŸ“¦ Installing backend dependencies..."
          cd crm-backend
          npm install --omit=dev
          
          # Build frontend
          echo "ğŸ—ï¸ Building frontend..."
          cd ../crm-frontend-only
          # Fix npm optional dependencies bug
          rm -rf package-lock.json node_modules
          npm install
          VITE_API_URL=http://54.221.136.112/api VITE_ENVIRONMENT=production npm run build
          
          # Copy frontend files to Nginx
          echo "ğŸ“‹ Copying frontend files to Nginx..."
          sudo cp -r dist/* /var/www/html/
          
          # Run database migrations
          echo "ğŸ—„ï¸ Running database migrations..."
          cd ../crm-backend
          npx sequelize-cli db:migrate --env production || echo "âš ï¸ Migration warning (might be OK)"
          
          # Update permissions
          echo "ğŸ” Setting permissions..."
          sudo chown -R ubuntu:ubuntu /var/www/netaq-crm
          chmod +x /var/www/netaq-crm/scripts/*.sh
          
          # Start services
          echo "â–¶ï¸ Starting services..."
          pm2 start "npm start" --name "netaq-backend" --cwd "/var/www/netaq-crm/crm-backend" || pm2 restart netaq-backend
          pm2 save
          
          # Restart nginx
          echo "ğŸ”„ Restarting Nginx..."
          sudo nginx -t && sudo systemctl reload nginx
          
          # Health check
          echo "ğŸ¥ Health check..."
          sleep 15
          if curl -f http://localhost:8000/api/health > /dev/null 2>&1; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Health check failed!"
            exit 1
          fi
          
          # Clean old backups (keep last 5)
          echo "ğŸ§¹ Cleaning old backups..."
          cd ~/backups
          ls -t backup_*.tar.gz | tail -n +6 | xargs rm -f || true
          
          echo "ğŸ‰ Deployment completed successfully!"

    # 6. Notify on Success
    - name: ğŸ“¢ Success Notification  
      if: success() && github.ref == 'refs/heads/main'
      run: |
        echo "âœ… Netaq CRM System deployed successfully to production!"
        echo "ğŸŒ Website: https://www.netaqcrm.site"
        echo "ğŸ”§ Backend API: https://www.netaqcrm.site:8000"

    # 7. Notify on Failure
    - name: âŒ Failure Notification
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "ğŸ“‹ Please check the logs above for details."
        echo "ğŸ”„ You may need to rollback manually on the server."

  # Health Check Job (runs after deploy)
  health-check:
    name: ğŸ¥ Post-Deploy Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ” Verify Deployment
      run: |
        echo "â³ Waiting for services to stabilize..."
        sleep 30
        
        echo "ğŸ¥ Checking backend health..."
        if curl -f http://54.221.136.112:8000/api/health; then
          echo "âœ… Backend is healthy!"
        else
          echo "âŒ Backend health check failed!"
          exit 1
        fi
        
        echo "ğŸŒ Checking frontend..."
        if curl -f http://54.221.136.112; then
          echo "âœ… Frontend is accessible!"
        else
          echo "âŒ Frontend check failed!"
          exit 1
        fi
        
        echo "ğŸ‰ All systems are operational!"