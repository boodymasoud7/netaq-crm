const { FollowUp, Lead, Client } = require('../../models');
const FollowUpIntegrationService = require('./followUpIntegrationService');

/**
 * ุฎุฏูุฉ ุงููุชุงุจุนุงุช ุงูุฐููุฉ
 * ุชุฏูุฑ ุงููุชุงุจุนุงุช ุจูุงุกู ุนูู ูุชุงุฆุฌ ุงูุชูุงุนู ูุน ุงูุนููุงุก
 */
class SmartFollowUpService {

  /**
   * ุฅูุดุงุก ูุชุงุจุนุฉ ุชุงููุฉ ุฐููุฉ ุจูุงุกู ุนูู ูุชูุฌุฉ ุงููุชุงุจุนุฉ ุงูุณุงุจูุฉ
   */
  static async createSmartNextFollowUp(completedFollowUpId, outcome) {
    try {
      console.log(`๐ง Creating smart next follow-up after completion of: ${completedFollowUpId} with outcome: ${outcome}`);
      
      const completedFollowUp = await FollowUp.findByPk(completedFollowUpId, {
        include: [
          {
            model: Lead,
            as: 'lead',
            attributes: ['id', 'name', 'status']
          },
          {
            model: Client,
            as: 'client',
            attributes: ['id', 'name', 'status']
          }
        ]
      });
      
      if (!completedFollowUp) {
        throw new Error(`Completed follow-up not found: ${completedFollowUpId}`);
      }
      
      // ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูุฌุจ ุฅูุดุงุก ูุชุงุจุนุฉ ุชุงููุฉ ุญุณุจ ุงููุชูุฌุฉ
      const shouldCreateNext = this.shouldCreateNextFollowUp(outcome);
      if (!shouldCreateNext.create) {
        console.log(`โธ๏ธ No next follow-up needed: ${shouldCreateNext.reason}`);
        
        // ุชุญุฏูุซ ุญุงูุฉ ุงูุนููู ุญุณุจ ุงููุชูุฌุฉ
        await this.updateLeadStatusByOutcome(completedFollowUp.leadId, outcome);
        
        return { 
          created: false, 
          reason: shouldCreateNext.reason,
          leadStatusUpdated: true 
        };
      }
      
      const leadName = completedFollowUp.lead?.name || 'ุงูุนููู';
      const nextFollowUpData = this.getNextFollowUpByOutcome(outcome, leadName);
      
      const nextDate = new Date();
      nextDate.setDate(nextDate.getDate() + nextFollowUpData.daysAfter);
      
      const nextFollowUp = await FollowUp.create({
        leadId: completedFollowUp.leadId,
        clientId: completedFollowUp.clientId,
        saleId: completedFollowUp.saleId,
        type: nextFollowUpData.type,
        title: nextFollowUpData.title,
        description: nextFollowUpData.description,
        scheduledDate: nextDate,
        priority: nextFollowUpData.priority,
        assignedTo: completedFollowUp.assignedTo,
        createdBy: completedFollowUp.assignedTo,
        contactMethod: nextFollowUpData.contactMethod,
        expectedOutcome: nextFollowUpData.expectedOutcome,
        isAutoGenerated: true,
        notes: `ูุชุงุจุนุฉ ุฐููุฉ ุจูุงุกู ุนูู ุงููุชูุฌุฉ: ${outcome}`
      });
      
      // ุฅูุดุงุก ุชุฐููุฑ ูููุชุงุจุนุฉ ุงูุฌุฏูุฏุฉ
      try {
        await FollowUpIntegrationService.createReminderForFollowUp(nextFollowUp);
      } catch (error) {
        console.error('โ๏ธ Failed to create reminder for next follow-up:', error);
      }
      
      // ุชุญุฏูุซ ุญุงูุฉ ุงูุนููู ุญุณุจ ุงููุชูุฌุฉ
      await this.updateLeadStatusByOutcome(completedFollowUp.leadId, outcome);
      
      console.log(`โ Smart next follow-up created: ${nextFollowUp.id} - ${nextFollowUp.title}`);
      return { 
        created: true, 
        followUp: nextFollowUp,
        leadStatusUpdated: true 
      };
      
    } catch (error) {
      console.error(`โ Error creating smart next follow-up:`, error);
      throw error;
    }
  }
  
  /**
   * ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูุฌุจ ุฅูุดุงุก ูุชุงุจุนุฉ ุชุงููุฉ
   */
  static shouldCreateNextFollowUp(outcome) {
    const outcomeActions = {
      'ููุชู': { create: true, reason: 'ุงูุนููู ููุชู - ูุณุชุญู ูุชุงุจุนุฉ' },
      'ููุชู ุฌุฏุงู': { create: true, reason: 'ุงูุนููู ููุชู ุฌุฏุงู - ูุญุชุงุฌ ูุชุงุจุนุฉ ุณุฑูุนุฉ' },
      'ูุญุชุงุฌ ููุช': { create: true, reason: 'ุงูุนููู ูุญุชุงุฌ ููุช - ูุชุงุจุนุฉ ุจุนุฏ ูุชุฑุฉ' },
      'ุทูุจ ุนุฑุถ ุณุนุฑ': { create: true, reason: 'ุงูุนููู ุทูุจ ุนุฑุถ ุณุนุฑ - ูุชุงุจุนุฉ ูุงูุฉ' },
      'ูุฑูุฏ ุงุฌุชูุงุน': { create: true, reason: 'ุงูุนููู ูุฑูุฏ ุงุฌุชูุงุน - ุฌุฏููุฉ ุนุฑุถ ุชูุฏููู' },
      'ูุฑูุฏ ูุนูููุงุช ุฃูุซุฑ': { create: true, reason: 'ุงูุนููู ูุญุชุงุฌ ูุนูููุงุช ุฅุถุงููุฉ' },
      'ุณูุชุตู ูุงุญูุงู': { create: true, reason: 'ุงูุนููู ูุนุฏ ุจุงูุงุชุตุงู - ูุชุงุจุนุฉ ููุชุฃูุฏ' },
      
      // ุญุงูุงุช ูุง ุชุณุชุญู ูุชุงุจุนุฉ
      'ุบูุฑ ููุชู': { create: false, reason: 'ุงูุนููู ุบูุฑ ููุชู - ุชููู ุงููุชุงุจุนุฉ' },
      'ุบูุฑ ููุชู ููุงุฆูุงู': { create: false, reason: 'ุงูุนููู ุฑูุถ ููุงุฆูุงู - ุชููู ุงููุชุงุจุนุฉ' },
      'ุฑูู ุฎุทุฃ': { create: false, reason: 'ุฑูู ุฎุทุฃ - ูุง ุชูุฌุฏ ุฅููุงููุฉ ูููุชุงุจุนุฉ' },
      'ูุญูู': { create: false, reason: 'ุชู ุชุญููู ุงูุนููู - ูุง ุญุงุฌุฉ ููุชุงุจุนุฉ' },
      'ููุชูู': { create: false, reason: 'ุชูุช ุงูุตููุฉ - ูุง ุญุงุฌุฉ ููุชุงุจุนุฉ' },
      'ุนููู ุญุงูู': { create: false, reason: 'ุฃุตุจุญ ุนููู - ุงูุชูู ููุชุงุจุนุฉ ุงูุนููุงุก' },
      
      // ุญุงูุงุช ุฎุงุตุฉ
      'ูุง ูุฑุฏ': { create: true, reason: 'ุงูุนููู ูุง ูุฑุฏ - ูุญุงููุฉ ุฃุฎูุฑุฉ ุจุนุฏ ูุชุฑุฉ' },
      'ูุดุบูู': { create: true, reason: 'ุงูุนููู ูุดุบูู - ูุนุงูุฏุฉ ุงูุงุชุตุงู' },
      'ูู ุงุฌุชูุงุน': { create: true, reason: 'ุงูุนููู ูู ุงุฌุชูุงุน - ุฅุนุงุฏุฉ ุงููุญุงููุฉ' }
    };
    
    return outcomeActions[outcome] || { create: true, reason: 'ูุชุงุจุนุฉ ุงูุชุฑุงุถูุฉ' };
  }
  
  /**
   * ุชุญุฏูุฏ ููุน ุงููุชุงุจุนุฉ ุงูุชุงููุฉ ุญุณุจ ุงููุชูุฌุฉ
   */
  static getNextFollowUpByOutcome(outcome, leadName) {
    const outcomeMapping = {
      'ููุชู': {
        type: 'call',
        title: `ูุชุงุจุนุฉ ุซุงููุฉ - ${leadName}`,
        description: 'ูุชุงุจุนุฉ ููุชุฃูุฏ ูู ุงูุงูุชูุงู ูุชูุฏูู ูุนูููุงุช ุฅุถุงููุฉ ุญูู ุงูุฎุฏูุงุช',
        daysAfter: 2,
        priority: 'medium',
        contactMethod: 'phone',
        expectedOutcome: 'ุชุญุฏูุฏ ุงุญุชูุงุฌุงุช ุฃูุซุฑ ุชูุตููุงู ูุฌุฏููุฉ ุนุฑุถ ุชูุฏููู'
      },
      
      'ููุชู ุฌุฏุงู': {
        type: 'demo',
        title: `ุนุฑุถ ุชูุฏููู ุนุงุฌู - ${leadName}`,
        description: 'ุงูุนููู ููุชู ุฌุฏุงู - ุนุฑุถ ุชูุฏููู ุณุฑูุน ูุงุณุชุบูุงู ุงูุญูุงุณ',
        daysAfter: 2,
        priority: 'urgent',
        contactMethod: 'video_call',
        expectedOutcome: 'ุฅููุงุน ุงูุนููู ูุฅุฑุณุงู ุนุฑุถ ุณุนุฑ ููุฑู'
      },
      
      'ูุญุชุงุฌ ููุช': {
        type: 'call',
        title: `ูุชุงุจุนุฉ ุฏูุฑูุฉ - ${leadName}`,
        description: 'ุงูุนููู ูุญุชุงุฌ ููุช ููุชูููุฑ - ูุชุงุจุนุฉ ุจุนุฏ ูุชุฑุฉ ูุงููุฉ ูููุฑุงุฑ',
        daysAfter: 7,
        priority: 'low',
        contactMethod: 'phone',
        expectedOutcome: 'ูุนุฑูุฉ ุงููุฑุงุฑ ุงูููุงุฆู ุฃู ุชุญุฏูุซ ุงููุถุน'
      },
      
      'ุทูุจ ุนุฑุถ ุณุนุฑ': {
        type: 'email',
        title: `ูุชุงุจุนุฉ ุนุฑุถ ุงูุณุนุฑ - ${leadName}`,
        description: 'ูุชุงุจุนุฉ ุจุนุฏ ุฅุฑุณุงู ุนุฑุถ ุงูุณุนุฑ ููุชุฃูุฏ ูู ุงูุงุณุชูุงู ูููุงูุดุฉ ุงูุชูุงุตูู',
        daysAfter: 2,
        priority: 'high',
        contactMethod: 'email',
        expectedOutcome: 'ููุงูุดุฉ ุนุฑุถ ุงูุณุนุฑ ูุงูุฅุฌุงุจุฉ ุนูู ุงูุงุณุชูุณุงุฑุงุช'
      },
      
      'ูุฑูุฏ ุงุฌุชูุงุน': {
        type: 'meeting',
        title: `ุงุฌุชูุงุน ูุน ${leadName}`,
        description: 'ุฌุฏููุฉ ุงุฌุชูุงุน ุฃู ุนุฑุถ ุชูุฏููู ุญุณุจ ุทูุจ ุงูุนููู',
        daysAfter: 2,
        priority: 'urgent',
        contactMethod: 'meeting',
        expectedOutcome: 'ุนุฑุถ ุชูุฏููู ููุตู ูุฅุบูุงู ุงูุตููุฉ'
      },
      
      'ูุฑูุฏ ูุนูููุงุช ุฃูุซุฑ': {
        type: 'email',
        title: `ุฅุฑุณุงู ูุนูููุงุช ุฅุถุงููุฉ - ${leadName}`,
        description: 'ุฅุฑุณุงู ูุนูููุงุช ุชูุตูููุฉ ุฃูุซุฑ ุนู ุงูุฎุฏูุงุช ุญุณุจ ุงูุชูุงู ุงูุนููู',
        daysAfter: 2,
        priority: 'medium',
        contactMethod: 'email',
        expectedOutcome: 'ุชูุฏูู ุงููุนูููุงุช ุงููุทููุจุฉ ูุฌุฏููุฉ ููุงููุฉ ูุชุงุจุนุฉ'
      },
      
      'ุณูุชุตู ูุงุญูุงู': {
        type: 'call',
        title: `ูุชุงุจุนุฉ ูุนุฏ ุงูุงุชุตุงู - ${leadName}`,
        description: 'ุงูุนููู ูุนุฏ ุจุงูุงุชุตุงู ูุงุญูุงู - ูุชุงุจุนุฉ ููุชุฃูุฏ ูู ุนุฏู ุงููุณูุงู',
        daysAfter: 5,
        priority: 'medium',
        contactMethod: 'phone',
        expectedOutcome: 'ุงูุชุฃูุฏ ูู ุงุณุชูุฑุงุฑ ุงูุงูุชูุงู ูุชุญุฏูุฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ'
      },
      
      'ูุง ูุฑุฏ': {
        type: 'call',
        title: `ูุญุงููุฉ ุฃุฎูุฑุฉ - ${leadName}`,
        description: 'ูุญุงููุฉ ุฃุฎูุฑุฉ ููุชูุงุตู ูุน ุงูุนููู ูุจู ุฅููุงู ุงููุชุงุจุนุฉ ููุงุฆูุงู',
        daysAfter: 7,
        priority: 'low',
        contactMethod: 'phone',
        expectedOutcome: 'ุงูุชุฃูุฏ ูู ุงุณุชูุฑุงุฑ ุงูุงูุชูุงู ุฃู ุฅุบูุงู ุงูููู'
      },
      
      'ูุดุบูู': {
        type: 'call',
        title: `ุฅุนุงุฏุฉ ุงุชุตุงู - ${leadName}`,
        description: 'ุงูุนููู ูุงู ูุดุบููุงู - ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูู ููุช ููุงุณุจ',
        daysAfter: 2,
        priority: 'medium',
        contactMethod: 'phone',
        expectedOutcome: 'ุงูุชูุงุตู ุงููุนุงู ูุน ุงูุนููู ูุงูุญุตูู ุนูู ุฑุฏ ูุงุถุญ'
      },
      
      'ูู ุงุฌุชูุงุน': {
        type: 'call',
        title: `ุฅุนุงุฏุฉ ุงุชุตุงู - ${leadName}`,
        description: 'ุงูุนููู ูุงู ูู ุงุฌุชูุงุน - ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูู ููุช ุฃูุถู',
        daysAfter: 2,
        priority: 'medium',
        contactMethod: 'phone',
        expectedOutcome: 'ุงูุชูุงุตู ูุน ุงูุนููู ุฎุงุฑุฌ ุฃููุงุช ุงูุงุฌุชูุงุนุงุช'
      }
    };
    
    // ุฅุฐุง ูู ุชูู ุงููุชูุฌุฉ ูุนุฑููุฉุ ุงุณุชุฎุฏู ูุชุงุจุนุฉ ุงูุชุฑุงุถูุฉ
    return outcomeMapping[outcome] || {
      type: 'call',
      title: `ูุชุงุจุนุฉ ุฏูุฑูุฉ - ${leadName}`,
      description: 'ูุชุงุจุนุฉ ุฏูุฑูุฉ ููุชุฃูุฏ ูู ุงูุชูุฏู ูุชุญุฏูุซ ุงููุถุน',
      daysAfter: 5,
      priority: 'medium',
      contactMethod: 'phone',
      expectedOutcome: 'ุชุญุฏูุซ ุญุงูุฉ ุงูุนููู ูุชุญุฏูุฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ'
    };
  }
  
  /**
   * ุชุญุฏูุซ ุญุงูุฉ ุงูุนููู ุงููุญุชูู ุจูุงุกู ุนูู ูุชูุฌุฉ ุงููุชุงุจุนุฉ
   */
  static async updateLeadStatusByOutcome(leadId, outcome) {
    try {
      const lead = await Lead.findByPk(leadId);
      if (!lead) return;
      
      const statusMapping = {
        'ููุชู': 'interested',
        'ููุชู ุฌุฏุงู': 'qualified',
        'ุทูุจ ุนุฑุถ ุณุนุฑ': 'qualified',
        'ูุฑูุฏ ุงุฌุชูุงุน': 'qualified',
        'ุบูุฑ ููุชู': 'not_interested',
        'ุบูุฑ ููุชู ููุงุฆูุงู': 'lost',
        'ูุญูู': 'converted',
        'ููุชูู': 'converted',
        'ุนููู ุญุงูู': 'converted',
        'ุฑูู ุฎุทุฃ': 'lost'
      };
      
      const newStatus = statusMapping[outcome];
      if (newStatus && newStatus !== lead.status) {
        await lead.update({ status: newStatus });
        console.log(`๐ Lead ${leadId} status updated to: ${newStatus} (outcome: ${outcome})`);
      }
      
    } catch (error) {
      console.error(`โ Error updating lead status:`, error);
    }
  }
  
  /**
   * ุงูุญุตูู ุนูู ูุงุฆูุฉ ุงููุชุงุฆุฌ ุงูููููุฉ ูููุชุงุจุนุงุช
   */
  static getAvailableOutcomes() {
    return [
      { value: 'ููุชู', label: '๐ ููุชู', color: 'green' },
      { value: 'ููุชู ุฌุฏุงู', label: '๐คฉ ููุชู ุฌุฏุงู', color: 'emerald' },
      { value: 'ูุญุชุงุฌ ููุช', label: 'โณ ูุญุชุงุฌ ููุช', color: 'yellow' },
      { value: 'ุทูุจ ุนุฑุถ ุณุนุฑ', label: '๐ฐ ุทูุจ ุนุฑุถ ุณุนุฑ', color: 'blue' },
      { value: 'ูุฑูุฏ ุงุฌุชูุงุน', label: '๐ค ูุฑูุฏ ุงุฌุชูุงุน', color: 'purple' },
      { value: 'ูุฑูุฏ ูุนูููุงุช ุฃูุซุฑ', label: '๐ ูุฑูุฏ ูุนูููุงุช ุฃูุซุฑ', color: 'indigo' },
      { value: 'ุณูุชุตู ูุงุญูุงู', label: '๐ ุณูุชุตู ูุงุญูุงู', color: 'cyan' },
      { value: 'ูุดุบูู', label: 'โฐ ูุดุบูู', color: 'orange' },
      { value: 'ูู ุงุฌุชูุงุน', label: '๐ฅ ูู ุงุฌุชูุงุน', color: 'orange' },
      { value: 'ูุง ูุฑุฏ', label: '๐ต ูุง ูุฑุฏ', color: 'gray' },
      { value: 'ุบูุฑ ููุชู', label: '๐ ุบูุฑ ููุชู', color: 'red' },
      { value: 'ุบูุฑ ููุชู ููุงุฆูุงู', label: 'โ ุบูุฑ ููุชู ููุงุฆูุงู', color: 'red' },
      { value: 'ุฑูู ุฎุทุฃ', label: '๐ฑ ุฑูู ุฎุทุฃ', color: 'red' },
      { value: 'ูุญูู', label: 'โ ูุญูู ูุนููู', color: 'green' },
      { value: 'ููุชูู', label: '๐ ููุชูู', color: 'green' }
    ];
  }
}

module.exports = SmartFollowUpService;
