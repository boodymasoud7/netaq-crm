const { FollowUp, Lead, Client, Sale, User } = require('../../models');
const { Op } = require('sequelize');
const FollowUpIntegrationService = require('./followUpIntegrationService');

class AutoFollowUpService {
  
  /**
   * Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙÙŠ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„
   * @param {number} daysToAdd - Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ù„Ù„Ø¥Ø¶Ø§ÙØ©
   * @param {string} preferredTime - Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ÙØ¶Ù„ ('morning'|'afternoon'|'random')
   * @returns {Date} Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø¶Ø¨ÙˆØ·
   */
  static calculateWorkingDateTime(daysToAdd, preferredTime = 'morning') {
    console.log(`ğŸ• calculateWorkingDateTime called: daysToAdd=${daysToAdd}, preferredTime=${preferredTime}`);
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ÙÙŠ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ (11 Øµ - 7 Ù…Ø³Ø§Ø¡Ù‹)
    let workingHour;
    let workingMinute = Math.floor(Math.random() * 60); // Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
    
    switch (preferredTime) {
      case 'morning':
        workingHour = 11 + Math.floor(Math.random() * 3); // 11, 12, 13
        break;
      case 'afternoon':
        workingHour = 15 + Math.floor(Math.random() * 3); // 15, 16, 17
        break;
      case 'random':
      default:
        workingHour = 11 + Math.floor(Math.random() * 8); // 11-18
        break;
    }
    
    console.log(`â° Selected working time: ${workingHour}:${workingMinute.toString().padStart(2, '0')}`);
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙˆØ§Ø¶Ø­Ø©
    const targetDate = new Date();
    const currentYear = targetDate.getFullYear();
    const currentMonth = targetDate.getMonth();
    const currentDay = targetDate.getDate();
    
    // Ø¥Ù†Ø´Ø§Ø¡ ØªØ§Ø±ÙŠØ® Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    const newDate = new Date(currentYear, currentMonth, currentDay + daysToAdd, workingHour, workingMinute, 0, 0);
    
    console.log(`ğŸ“… Before weekend check: ${newDate.toISOString()}`);
    
    // ØªØ¬Ù†Ø¨ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø§Ù„Ø¬Ù…Ø¹Ø© = 5ØŒ Ø§Ù„Ø³Ø¨Øª = 6)
    while (newDate.getDay() === 5 || newDate.getDay() === 6) {
      newDate.setDate(newDate.getDate() + 1);
      console.log(`â­ï¸ Skipping weekend, moved to: ${newDate.toISOString()}`);
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ù…Ø§Ø¶ÙŠØŒ Ø§Ù†ØªÙ‚Ù„ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ
    const now = new Date();
    if (newDate <= now) {
      newDate.setDate(newDate.getDate() + 1);
      // ØªØ¬Ù†Ø¨ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
      while (newDate.getDay() === 5 || newDate.getDay() === 6) {
        newDate.setDate(newDate.getDate() + 1);
      }
      console.log(`â­ï¸ Time was in past, moved to: ${newDate.toISOString()}`);
    }
    
    const dayNames = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
    console.log(`âœ… Final scheduled time: ${newDate.toISOString()} (${dayNames[newDate.getDay()]}) - Local: ${workingHour}:${workingMinute.toString().padStart(2, '0')}`);
    
    return newDate;
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ§Ø¨Ø¹Ø© Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø· Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­ØªÙ…Ù„ Ø¬Ø¯ÙŠØ¯
  static async createLeadFollowUps(leadId, assignedToUserId, createdByUserId = null) {
    try {
      const lead = await Lead.findByPk(leadId);
      if (!lead) {
        throw new Error(`Lead not found: ${leadId}`);
      }

      // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙØ³ØªØ¯Ø¹Ù‰ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„

      const followUps = [];
      
      // Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¤Ø¬Ù„Ø© - Ø§ØªØµØ§Ù„ ØªØ±Ø­ÙŠØ¨ÙŠ
      const firstFollowUp = await FollowUp.create({
        leadId: leadId,
        type: 'call',
        title: `Ø§ØªØµØ§Ù„ ØªØ±Ø­ÙŠØ¨ÙŠ - ${lead.name}`,
        description: `Ø§ØªØµØ§Ù„ ØªØ±Ø­ÙŠØ¨ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙ…Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙ‡ ÙˆØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©. Ù…Ø¬Ø¯ÙˆÙ„Ø© ÙÙŠ ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„.`,
        scheduledDate: this.calculateWorkingDateTime(1, 'morning'), // ØºØ¯Ø§Ù‹ ØµØ¨Ø§Ø­Ø§Ù‹
        priority: 'high',
        assignedTo: assignedToUserId, // Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø®ØµØµ Ù„Ù‡ Ø§Ù„Ø¹Ù…ÙŠÙ„
        createdBy: createdByUserId || assignedToUserId, // Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø°ÙŠ Ù‚Ø§Ù… Ø¨Ø§Ù„ØªÙˆØ²ÙŠØ¹
        contactMethod: 'phone',
        expectedOutcome: 'ÙÙ‡Ù… Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªÙˆÙ‰ Ø§Ù‡ØªÙ…Ø§Ù…Ù‡',
        notes: 'Ù…ØªØ§Ø¨Ø¹Ø© Ø£ÙˆÙ„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© - Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø³ØªØªÙ… Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©',
        isAutoGenerated: true
      });
      followUps.push(firstFollowUp);
      
      // Ù„Ø§ Ù†Ù†Ø´Ø¦ Ù…ØªØ§Ø¨Ø¹Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© - Ø³ØªØªÙ… Ø­Ø³Ø¨ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
      
      console.log(`âœ… Created 1 initial follow-up for lead ${leadId}`);
      
      // Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒÙŠØ± ÙˆØ¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
      await FollowUpIntegrationService.createReminderForFollowUp(firstFollowUp);
      
      return followUps;
      
    } catch (error) {
      console.error(`âŒ Error creating auto follow-ups for lead ${leadId}:`, error);
      throw error;
    }
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ§Ø¨Ø¹Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ø¹Ù…ÙŠÙ„ ÙØ¹Ù„ÙŠ Ø¬Ø¯ÙŠØ¯
  static async createClientFollowUps(clientId, assignedToUserId, createdByUserId = null) {
    try {
      const client = await Client.findByPk(clientId);
      if (!client) {
        throw new Error(`Client not found: ${clientId}`);
      }

      // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙØ³ØªØ¯Ø¹Ù‰ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„

      const followUps = [];
      
      // Ù…ØªØ§Ø¨Ø¹Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ©
      // ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø­Ø³Ø¨ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„
      
      const welcomeFollowUp = await FollowUp.create({
        clientId: clientId,
        type: 'call',
        title: `Ø§ØªØµØ§Ù„ ØªØ±Ø­ÙŠØ¨ÙŠ - ${client.name}`,
        description: `Ø§ØªØµØ§Ù„ ØªØ±Ø­ÙŠØ¨ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø¶Ø§Ù‡ ÙˆØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù„Ø§Ø²Ù….`,
        scheduledDate: this.calculateWorkingDateTime(0, 'afternoon'), // Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø± Ø£Ùˆ ØºØ¯Ø§Ù‹
        priority: 'high',
        assignedTo: assignedToUserId, // Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø®ØµØµ Ù„Ù‡ Ø§Ù„Ø¹Ù…ÙŠÙ„
        createdBy: createdByUserId || assignedToUserId, // Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø°ÙŠ Ù‚Ø§Ù… Ø¨Ø§Ù„ØªÙˆØ²ÙŠØ¹
        contactMethod: 'phone',
        expectedOutcome: 'ØªØ£ÙƒÙŠØ¯ Ø±Ø¶Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙÙ‡Ù… Ù…ØªØ·Ù„Ø¨Ø§ØªÙ‡',
        isAutoGenerated: true
      });
      followUps.push(welcomeFollowUp);
      
      // Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙˆØ±ÙŠØ© Ø¨Ø¹Ø¯ Ø£Ø³Ø¨ÙˆØ¹
      const weeklyFollowUpDate = new Date();
      weeklyFollowUpDate.setDate(weeklyFollowUpDate.getDate() + 7);
      
      const weeklyFollowUp = await FollowUp.create({
        clientId: clientId,
        type: 'call',
        title: `Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙˆØ±ÙŠØ© - ${client.name}`,
        description: `Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙˆØ±ÙŠØ© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø³ÙŠØ± Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ.`,
        scheduledDate: weeklyFollowUpDate,
        priority: 'medium',
        assignedTo: assignedToUserId,
        createdBy: assignedToUserId,
        contactMethod: 'phone',
        expectedOutcome: 'ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø±Ø¶Ø§ ÙˆØªØ­Ø¯ÙŠØ¯ ÙØ±Øµ Ø¬Ø¯ÙŠØ¯Ø©',
        isAutoGenerated: true
      });
      followUps.push(weeklyFollowUp);
      
      console.log(`âœ… Created ${followUps.length} auto follow-ups for client ${clientId}`);
      
      // Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒÙŠØ±Ø§Øª ÙˆØ¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„ÙƒÙ„ Ù…ØªØ§Ø¨Ø¹Ø©
      for (const followUp of followUps) {
        await FollowUpIntegrationService.createReminderForFollowUp(followUp);
      }
      
      return followUps;
      
    } catch (error) {
      console.error(`âŒ Error creating auto follow-ups for client ${clientId}:`, error);
      throw error;
    }
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ§Ø¨Ø¹Ø© ØªØ§Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
  static async createNextFollowUp(completedFollowUp, outcome, nextAction, assignedToUserId, createdByUserId = null) {
    try {
      console.log(`ğŸ”„ Creating next follow-up based on outcome: ${outcome}`);
      
      let followUpData = {};
      const baseDate = new Date();
      
      switch (outcome) {
        case 'interested':
          followUpData = {
            type: 'call',
            title: `Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù‡ØªÙ…Ø§Ù… - ${completedFollowUp.lead?.name || completedFollowUp.client?.name || 'Ø¹Ù…ÙŠÙ„'}`,
            description: `Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ø¨Ø¯Ù‰ Ø§Ù‡ØªÙ…Ø§Ù…Ø§Ù‹ØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª.`,
            scheduledDate: this.calculateWorkingDateTime(2, 'morning'), // Ø¨Ø¹Ø¯ ÙŠÙˆÙ…ÙŠÙ† ØµØ¨Ø§Ø­Ø§Ù‹
            priority: 'high',
            expectedOutcome: 'Ø¬Ø¯ÙˆÙ„Ø© Ø¹Ø±Ø¶ ØªÙ‚Ø¯ÙŠÙ…ÙŠ Ø£Ùˆ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©'
          };
          break;
          
        case 'needs_info':
          followUpData = {
            type: 'email',
            title: `Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª - ${completedFollowUp.lead?.name || completedFollowUp.client?.name || 'Ø¹Ù…ÙŠÙ„'}`,
            description: `Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ­ØªØ§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©ØŒ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆÙ…ØªØ§Ø¨Ø¹Ø©.`,
            scheduledDate: this.calculateWorkingDateTime(1, 'morning'), // ØºØ¯Ø§Ù‹ ØµØ¨Ø§Ø­Ø§Ù‹
            priority: 'high',
            expectedOutcome: 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø±'
          };
          break;
          
        case 'call_later':
          followUpData = {
            type: 'call',
            title: `Ø¥Ø¹Ø§Ø¯Ø© Ø§ØªØµØ§Ù„ - ${completedFollowUp.lead?.name || completedFollowUp.client?.name || 'Ø¹Ù…ÙŠÙ„'}`,
            description: `Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ ÙˆÙ‚Øª Ù„Ø§Ø­Ù‚.`,
            scheduledDate: this.calculateWorkingDateTime(3, 'afternoon'), // Ø¨Ø¹Ø¯ 3 Ø£ÙŠØ§Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±
            priority: 'medium',
            expectedOutcome: 'ØªÙˆØ§ØµÙ„ Ù†Ø§Ø¬Ø­ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©'
          };
          break;
          
        case 'meeting_scheduled':
          followUpData = {
            type: 'meeting',
            title: `Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ - ${completedFollowUp.lead?.name || completedFollowUp.client?.name || 'Ø¹Ù…ÙŠÙ„'}`,
            description: `Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.`,
            scheduledDate: this.calculateWorkingDateTime(7, 'morning'), // Ø¨Ø¹Ø¯ Ø£Ø³Ø¨ÙˆØ¹ ØµØ¨Ø§Ø­Ø§Ù‹
            priority: 'high',
            expectedOutcome: 'Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø±Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„'
          };
          break;
          
        case 'quotation_sent':
          followUpData = {
            type: 'call',
            title: `Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± - ${completedFollowUp.lead?.name || completedFollowUp.client?.name || 'Ø¹Ù…ÙŠÙ„'}`,
            description: `Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø±Ø³Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙ…Ø¹Ø±ÙØ© Ø±Ø£ÙŠÙ‡.`,
            scheduledDate: this.calculateWorkingDateTime(2, 'afternoon'), // Ø¨Ø¹Ø¯ ÙŠÙˆÙ…ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±
            priority: 'high',
            expectedOutcome: 'Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨'
          };
          break;
          
        case 'no_answer':
          followUpData = {
            type: 'call',
            title: `Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© - ${completedFollowUp.lead?.name || completedFollowUp.client?.name || 'Ø¹Ù…ÙŠÙ„'}`,
            description: `Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.`,
            scheduledDate: this.calculateWorkingDateTime(1, 'random'), // ØºØ¯Ø§Ù‹ ÙÙŠ ÙˆÙ‚Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            priority: 'medium',
            expectedOutcome: 'Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ­Ø¯Ø« Ù…Ø¹Ù‡'
          };
          break;
          
        case 'not_interested':
          // Ù„Ø§ Ù†Ù†Ø´Ø¦ Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ù…Ù‡ØªÙ…ÙŠÙ†
          console.log(`â¸ï¸ No next follow-up needed for "not_interested" outcome`);
          return null;
          
        default:
          // Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ø§Ù…Ø© Ù„Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£Ø®Ø±Ù‰
          followUpData = {
            type: 'call',
            title: `Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ø§Ù…Ø© - ${completedFollowUp.lead?.name || completedFollowUp.client?.name || 'Ø¹Ù…ÙŠÙ„'}`,
            description: nextAction || `Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ø§Ù…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${outcome}`,
            scheduledDate: this.calculateWorkingDateTime(3, 'random'), // Ø¨Ø¹Ø¯ 3 Ø£ÙŠØ§Ù… ÙÙŠ ÙˆÙ‚Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            priority: 'medium',
            expectedOutcome: 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„'
          };
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
      const nextFollowUp = await FollowUp.create({
        ...followUpData,
        leadId: completedFollowUp.leadId,
        clientId: completedFollowUp.clientId,
        saleId: completedFollowUp.saleId,
        assignedTo: assignedToUserId,
        createdBy: createdByUserId || assignedToUserId,
        contactMethod: followUpData.type === 'email' ? 'email' : 'phone',
        notes: `Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${outcome}`,
        isAutoGenerated: true
      });
      
      console.log(`âœ… Created next follow-up: ${nextFollowUp.title}`);
      
      // Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒÙŠØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      await FollowUpIntegrationService.createReminderForFollowUp(nextFollowUp);
      
      return nextFollowUp;
      
    } catch (error) {
      console.error(`âŒ Error creating next follow-up:`, error);
      throw error;
    }
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙ…Ù„
  static async createFollowUpBasedOnStatus(leadId, newStatus, assignedToUserId) {
    try {
      console.log(`ğŸ”„ Creating status-based follow-up for Lead ${leadId}: ${newStatus}`);
      
      const lead = await Lead.findByPk(leadId);
      if (!lead) {
        throw new Error(`Lead not found: ${leadId}`);
      }

      let followUpData = {};
      const baseDate = new Date();
      
      switch (newStatus) {
        case 'interested':
          followUpData = {
            type: 'call',
            title: `Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù‡ØªÙ…Ø§Ù… - ${lead.name}`,
            description: `Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ø¨Ø¯Ù‰ Ø§Ù‡ØªÙ…Ø§Ù…Ø§Ù‹ØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©.`,
            scheduledDate: new Date(baseDate.getTime() + 24 * 60 * 60 * 1000), // ØºØ¯Ø§Ù‹
            priority: 'high',
            expectedOutcome: 'Ø¬Ø¯ÙˆÙ„Ø© Ø¹Ø±Ø¶ ØªÙ‚Ø¯ÙŠÙ…ÙŠ Ø£Ùˆ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©'
          };
          break;
          
        case 'contacted':
          followUpData = {
            type: 'call',
            title: `Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØ§ØµÙ„ - ${lead.name}`,
            description: `Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø±Ø£ÙŠ ÙˆØ§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©.`,
            scheduledDate: new Date(baseDate.getTime() + 2 * 24 * 60 * 60 * 1000), // Ø¨Ø¹Ø¯ ÙŠÙˆÙ…ÙŠÙ†
            priority: 'medium',
            expectedOutcome: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù… ÙˆØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ù„Ù„Ù‚Ø§Ø¡'
          };
          break;
          
        case 'qualified':
          followUpData = {
            type: 'demo',
            title: `Ø¹Ø±Ø¶ ØªÙ‚Ø¯ÙŠÙ…ÙŠ - ${lead.name}`,
            description: `Ø¹Ù…ÙŠÙ„ Ù…Ø¤Ù‡Ù„ØŒ Ø¬Ø¯ÙˆÙ„Ø© Ø¹Ø±Ø¶ ØªÙ‚Ø¯ÙŠÙ…ÙŠ ØªÙØµÙŠÙ„ÙŠ.`,
            scheduledDate: new Date(baseDate.getTime() + 3 * 24 * 60 * 60 * 1000), // Ø¨Ø¹Ø¯ 3 Ø£ÙŠØ§Ù…
            priority: 'high',
            expectedOutcome: 'Ø¥Ù‚Ù†Ø§Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø³Ø¹Ø±'
          };
          break;
          
        case 'proposal_sent':
          followUpData = {
            type: 'call',
            title: `Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± - ${lead.name}`,
            description: `Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø±Ø¯.`,
            scheduledDate: new Date(baseDate.getTime() + 3 * 24 * 60 * 60 * 1000), // Ø¨Ø¹Ø¯ 3 Ø£ÙŠØ§Ù…
            priority: 'high',
            expectedOutcome: 'Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯ ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„ØµÙÙ‚Ø©'
          };
          break;
          
        case 'negotiation':
          followUpData = {
            type: 'meeting',
            title: `Ø§Ø¬ØªÙ…Ø§Ø¹ ØªÙØ§ÙˆØ¶ - ${lead.name}`,
            description: `Ø§Ø¬ØªÙ…Ø§Ø¹ Ù„Ù…Ù†Ø§Ù‚Ø´Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ù„Ø§ØªÙØ§Ù‚ Ù†Ù‡Ø§Ø¦ÙŠ.`,
            scheduledDate: new Date(baseDate.getTime() + 24 * 60 * 60 * 1000), // ØºØ¯Ø§Ù‹
            priority: 'urgent',
            expectedOutcome: 'Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø§ØªÙØ§Ù‚ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„ØµÙÙ‚Ø©'
          };
          break;
          
        case 'not_interested':
          followUpData = {
            type: 'email',
            title: `Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ© - ${lead.name}`,
            description: `Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ© Ù„Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ø§Ù„Ù…Ù‡ØªÙ… Ø­Ø§Ù„ÙŠØ§Ù‹.`,
            scheduledDate: new Date(baseDate.getTime() + 30 * 24 * 60 * 60 * 1000), // Ø¨Ø¹Ø¯ Ø´Ù‡Ø±
            priority: 'low',
            expectedOutcome: 'Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ø¸Ø±ÙˆÙ ÙˆØ§Ù„Ø§Ù‡ØªÙ…Ø§Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ'
          };
          break;
          
        default:
          console.log(`No auto follow-up rule for status: ${newStatus}`);
          return null;
      }
      
      const followUp = await FollowUp.create({
        leadId: leadId,
        ...followUpData,
        assignedTo: assignedToUserId,
        createdBy: assignedToUserId,
        contactMethod: followUpData.type === 'call' ? 'phone' : 'email',
        isAutoGenerated: true
      });
      
      console.log(`âœ… Created status-based follow-up for lead ${leadId}: ${followUp.id}`);
      return followUp;
      
    } catch (error) {
      console.error(`âŒ Error creating status-based follow-up for lead ${leadId}:`, error);
      throw error;
    }
  }
  
  // Ø¬Ø¯ÙˆÙ„Ø© Ù…ØªØ§Ø¨Ø¹Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¯ÙˆØ±ÙŠØ© (ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡Ø§ Ù…Ù† cron job)
  static async scheduleAutomaticFollowUps() {
    try {
      console.log('ğŸ¤– Running automatic follow-up scheduling...');
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ØªØªÙ… Ù…ØªØ§Ø¨Ø¹ØªÙ‡Ù… Ù…Ù†Ø° Ø£ÙƒØ«Ø± Ù…Ù† 7 Ø£ÙŠØ§Ù…
      const staleLeads = await Lead.findAll({
        where: {
          status: {
            [Op.notIn]: ['converted', 'lost', 'not_interested']
          },
          assignedTo: {
            [Op.ne]: null
          },
          updatedAt: {
            [Op.lt]: new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000)
          }
        }
      });
      
      let createdFollowUps = 0;
      
      for (const lead of staleLeads) {
        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…ØªØ§Ø¨Ø¹Ø§Øª Ù…Ø¬Ø¯ÙˆÙ„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„
        const existingFollowUp = await FollowUp.findOne({
          where: {
            leadId: lead.id,
            status: 'scheduled',
            scheduledDate: {
              [Op.gte]: today
            }
          }
        });
        
        if (!existingFollowUp) {
          await this.createFollowUpBasedOnStatus(lead.id, lead.status, lead.assignedTo);
          createdFollowUps++;
        }
      }
      
      console.log(`âœ… Automatic follow-up scheduling completed: ${createdFollowUps} follow-ups created`);
      return { success: true, created: createdFollowUps };
      
    } catch (error) {
      console.error('âŒ Error in automatic follow-up scheduling:', error);
      throw error;
    }
  }
  
  // ØªÙˆØ²ÙŠØ¹ Ù…ØªØ§Ø¨Ø¹Ø§Øª Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ† Ø§Ù„Ù…ÙˆØ²Ø¹ÙŠÙ† (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† Ø§Ù„ÙØ±ÙˆÙ†Øª Ø¥Ù†Ø¯)
  static async distributeFollowUpsWithLeads(followUpAssignments, createdBy) {
    try {
      console.log(`ğŸ¯ Distributing follow-ups for ${followUpAssignments.length} leads`);
      
      const results = [];
      
      for (const assignment of followUpAssignments) {
        try {
          console.log(`ğŸ¯ Creating follow-ups for Lead ${assignment.leadId} â†’ User ${assignment.assignedTo}`);
          const followUps = await this.createLeadFollowUps(
            assignment.leadId, 
            assignment.assignedTo,
            createdBy
          );
          
          results.push({
            leadId: assignment.leadId,
            leadName: assignment.leadName,
            assignedTo: assignment.assignedTo,
            followUpsCreated: followUps.length,
            success: true
          });
          
        } catch (error) {
          console.error(`âŒ Failed to create follow-ups for lead ${assignment.leadId}:`, error);
          results.push({
            leadId: assignment.leadId,
            leadName: assignment.leadName,
            assignedTo: assignment.assignedTo,
            followUpsCreated: 0,
            success: false,
            error: error.message
          });
        }
      }
      
      const successful = results.filter(r => r.success).length;
      console.log(`âœ… Follow-up distribution completed: ${successful}/${results.length} successful`);
      
      return results;
      
    } catch (error) {
      console.error('âŒ Error in follow-up distribution:', error);
      throw error;
    }
  }
}

module.exports = AutoFollowUpService;
