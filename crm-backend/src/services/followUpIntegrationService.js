const { SimpleReminder, FollowUp } = require('../../models');
const notificationEmitter = require('../utils/notificationEmitter');

/**
 * ุฎุฏูุฉ ุชูุงูู ุงููุชุงุจุนุงุช ูุน ุงูุชุฐููุฑุงุช ูุงูุฅุดุนุงุฑุงุช
 * ุชุฑุจุท ุจูู ุงูุฃูุธูุฉ ุงูุซูุงุซุฉ: FollowUps, SimpleReminders, Notifications
 */
class FollowUpIntegrationService {

  /**
   * ุฅูุดุงุก ุชุฐููุฑ ุชููุงุฆู ูููุชุงุจุนุฉ
   * ูุชู ุงุณุชุฏุนุงุคูุง ุนูุฏ ุฅูุดุงุก ูุชุงุจุนุฉ ุฌุฏูุฏุฉ
   */
  static async createReminderForFollowUp(followUp) {
    try {
      console.log(`๐ Creating reminder for follow-up: ${followUp.title}`);
      
      // ุฅูุดุงุก ุชุฐููุฑ ูุจู ููุนุฏ ุงููุชุงุจุนุฉ ุจู 30 ุฏูููุฉ
      const reminderTime = new Date(followUp.scheduledDate);
      reminderTime.setMinutes(reminderTime.getMinutes() - 30);
      
      // ูุง ููุดุฆ ุชุฐููุฑ ุฅุฐุง ูุงู ุงูููุช ูู ุงููุงุถู
      if (reminderTime <= new Date()) {
        console.log('โฐ Reminder time is in the past, skipping reminder creation');
        return null;
      }
      
      const reminderNote = `๐ ูุชุงุจุนุฉ ูุณุชุญูุฉ: ${followUp.title}\n` +
                          `๐ ุงูููุนุฏ: ${followUp.scheduledDate.toLocaleString('ar-EG')}\n` +
                          `๐ ุงูููุน: ${this.getFollowUpTypeArabic(followUp.type)}\n` +
                          `โก ุงูุฃููููุฉ: ${this.getPriorityArabic(followUp.priority)}`;
      
      const reminder = await SimpleReminder.create({
        user_id: followUp.assignedTo,
        note: reminderNote,
        remind_at: reminderTime,
        status: 'pending',
        // ุฑุจุท ุงูุชุฐููุฑ ุจุงูุนููู ุฃู ุงูุนููู ุงููุญุชูู ุญุณุจ ุงููุชููุฑ
        client_id: followUp.clientId || null,
        lead_id: followUp.leadId || null,
        type: 'follow_up',
        description: `ูุชุงุจุนุฉ ุฑูู ${followUp.id}: ${followUp.title}`
      });
      
      console.log(`โ Reminder created for follow-up ${followUp.id}: ${reminder.id}`);
      
      // ุฅุฑุณุงู ุฅุดุนุงุฑ ููุฑู ุจุฅูุดุงุก ุงููุชุงุจุนุฉ
      await this.notifyFollowUpCreated(followUp);
      
      return reminder;
      
    } catch (error) {
      console.error(`โ Error creating reminder for follow-up ${followUp.id}:`, error);
      // ูุง ูููู ุงูุนูููุฉ ุฅุฐุง ูุดู ุฅูุดุงุก ุงูุชุฐููุฑ
      return null;
    }
  }
  
  /**
   * ุฅุฑุณุงู ุฅุดุนุงุฑ ุนูุฏ ุฅูุดุงุก ูุชุงุจุนุฉ ุฌุฏูุฏุฉ
   */
  static async notifyFollowUpCreated(followUp) {
    try {
      // ุฅุดุนุงุฑ ุงูููุธู ุงููุฎุตุต ูู ุงููุชุงุจุนุฉ
      const employeeNotification = {
        type: 'followUpAssigned',
        title: '๐ ูุชุงุจุนุฉ ุฌุฏูุฏุฉ ูุฎุตุตุฉ ูู',
        message: `ุชู ุชุฎุตูุต ูุชุงุจุนุฉ ุฌุฏูุฏุฉ: ${followUp.title}`,
        employeeId: followUp.assignedTo,
        followUpId: followUp.id,
        scheduledDate: followUp.scheduledDate,
        priority: followUp.priority,
        followUpType: followUp.type
      };
      
      notificationEmitter.emit('followUpAssigned', employeeNotification);
      
      // ุฅุดุนุงุฑ ุงููุฏุฑุงุก ุจุงููุชุงุจุนุฉ ุงูุฌุฏูุฏุฉ
      const managerNotification = {
        type: 'newFollowUpCreated',
        title: '๐ ูุชุงุจุนุฉ ุฌุฏูุฏุฉ ูู ุงููุธุงู',
        message: `ุชู ุฅูุดุงุก ูุชุงุจุนุฉ ุฌุฏูุฏุฉ: ${followUp.title}`,
        followUpId: followUp.id,
        assignedTo: followUp.assignedTo,
        scheduledDate: followUp.scheduledDate,
        priority: followUp.priority,
        isAutoGenerated: followUp.isAutoGenerated
      };
      
      notificationEmitter.emit('managerNotification', managerNotification);
      
      console.log(`๐ค Notifications sent for follow-up creation: ${followUp.id}`);
      
    } catch (error) {
      console.error(`โ Error sending follow-up creation notifications:`, error);
    }
  }
  
  /**
   * ุฅุฑุณุงู ุฅุดุนุงุฑ ุนูุฏ ุงูุชุฑุงุจ ููุนุฏ ุงููุชุงุจุนุฉ
   */
  static async notifyFollowUpDue(followUp) {
    try {
      const dueNotification = {
        type: 'followUpDue',
        title: 'โฐ ูุชุงุจุนุฉ ูุณุชุญูุฉ ุงูุขู',
        message: `ุญุงู ููุนุฏ ุงููุชุงุจุนุฉ: ${followUp.title}`,
        employeeId: followUp.assignedTo,
        followUpId: followUp.id,
        scheduledDate: followUp.scheduledDate,
        priority: 'urgent'
      };
      
      notificationEmitter.emit('followUpDue', dueNotification);
      
      console.log(`โฐ Due notification sent for follow-up: ${followUp.id}`);
      
    } catch (error) {
      console.error(`โ Error sending follow-up due notification:`, error);
    }
  }
  
  /**
   * ุฅุฑุณุงู ุฅุดุนุงุฑ ุนูุฏ ุชุฃุฎุฑ ุงููุชุงุจุนุฉ
   */
  static async notifyFollowUpOverdue(followUp) {
    try {
      // ุฅุดุนุงุฑ ุงูููุธู
      const employeeNotification = {
        type: 'followUpOverdue',
        title: '๐จ ูุชุงุจุนุฉ ูุชุฃุฎุฑุฉ',
        message: `ูุชุงุจุนุฉ ูุชุฃุฎุฑุฉ: ${followUp.title}`,
        employeeId: followUp.assignedTo,
        followUpId: followUp.id,
        scheduledDate: followUp.scheduledDate,
        priority: 'urgent'
      };
      
      notificationEmitter.emit('followUpOverdue', employeeNotification);
      
      // ุฅุดุนุงุฑ ุงููุฏูุฑ ุฃูุถุงู
      const managerNotification = {
        type: 'employeeOverdueFollowUp',
        title: '๐จ ููุธู ูุฏูู ูุชุงุจุนุฉ ูุชุฃุฎุฑุฉ',
        message: `ูุชุงุจุนุฉ ูุชุฃุฎุฑุฉ ููููุธู: ${followUp.title}`,
        employeeId: followUp.assignedTo,
        followUpId: followUp.id,
        scheduledDate: followUp.scheduledDate
      };
      
      notificationEmitter.emit('managerNotification', managerNotification);
      
      console.log(`๐จ Overdue notifications sent for follow-up: ${followUp.id}`);
      
    } catch (error) {
      console.error(`โ Error sending follow-up overdue notifications:`, error);
    }
  }
  
  /**
   * ุญุฐู ุงูุชุฐููุฑ ุงููุฑุชุจุท ุจุงููุชุงุจุนุฉ ุนูุฏ ุญุฐู ุฃู ุฅููุงู ุงููุชุงุจุนุฉ
   */
  static async removeReminderForFollowUp(followUpId) {
    try {
      // ุชู ุชุนุทูู ูุฐู ุงููุธููุฉ ูุคูุชุงู ุจุณุจุจ ุนุฏู ูุฌูุฏ ุฃุนูุฏุฉ related_type ู related_id
      // ูู ุฌุฏูู simple_reminders
      console.log(`โ๏ธ Skipping reminder removal for follow-up ${followUpId} - feature disabled`);
      return 0;
      
    } catch (error) {
      console.error(`โ Error removing reminders for follow-up ${followUpId}:`, error);
      return 0;
    }
  }
  
  /**
   * ูุญุต ุงููุชุงุจุนุงุช ุงููุณุชุญูุฉ ูุงููุชุฃุฎุฑุฉ (ูุชู ุงุณุชุฏุนุงุคูุง ูู cron job)
   */
  static async checkFollowUpsDueAndOverdue() {
    try {
      console.log('๐ Checking due and overdue follow-ups...');
      
      const now = new Date();
      const fifteenMinutesAgo = new Date(now.getTime() - 15 * 60 * 1000);
      const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
      
      // ุงููุชุงุจุนุงุช ุงููุณุชุญูุฉ ุงูุขู (ูู ุขุฎุฑ 15 ุฏูููุฉ)
      const dueFollowUps = await FollowUp.findAll({
        where: {
          status: 'scheduled',
          scheduledDate: {
            [require('sequelize').Op.between]: [fifteenMinutesAgo, now]
          }
        }
      });
      
      // ุงููุชุงุจุนุงุช ุงููุชุฃุฎุฑุฉ (ุฃูุซุฑ ูู ุณุงุนุฉ)
      const overdueFollowUps = await FollowUp.findAll({
        where: {
          status: 'scheduled',
          scheduledDate: {
            [require('sequelize').Op.lt]: oneHourAgo
          }
        }
      });
      
      // ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุงููุชุงุจุนุงุช ุงููุณุชุญูุฉ
      for (const followUp of dueFollowUps) {
        await this.notifyFollowUpDue(followUp);
      }
      
      // ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุงููุชุงุจุนุงุช ุงููุชุฃุฎุฑุฉ
      for (const followUp of overdueFollowUps) {
        await this.notifyFollowUpOverdue(followUp);
      }
      
      console.log(`โ Processed ${dueFollowUps.length} due and ${overdueFollowUps.length} overdue follow-ups`);
      
      return {
        due: dueFollowUps.length,
        overdue: overdueFollowUps.length
      };
      
    } catch (error) {
      console.error('โ Error checking due and overdue follow-ups:', error);
      return { due: 0, overdue: 0 };
    }
  }
  
  // Helper methods
  static getFollowUpTypeArabic(type) {
    const types = {
      'call': 'ููุงููุฉ ูุงุชููุฉ',
      'email': 'ุจุฑูุฏ ุฅููุชุฑููู', 
      'meeting': 'ุงุฌุชูุงุน',
      'demo': 'ุนุฑุถ ุชูุฏููู',
      'whatsapp': 'ูุงุชุณุงุจ',
      'visit': 'ุฒูุงุฑุฉ'
    };
    return types[type] || type;
  }
  
  static getPriorityArabic(priority) {
    const priorities = {
      'low': 'ููุฎูุถุฉ',
      'medium': 'ูุชูุณุทุฉ',
      'high': 'ุนุงููุฉ',
      'urgent': 'ุนุงุฌูุฉ'
    };
    return priorities[priority] || priority;
  }
}

module.exports = FollowUpIntegrationService;

